<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>æ•ˆæœŸæª¢æŸ¥è¡¨ Viewer</title>
  <!-- 1âƒ£ ç›´æ¥æ‹‰ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link  href="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
  <style>
    body{font-family: system-ui, sans-serif;margin:1rem;}
    #uploader{margin-bottom:1rem;}
    .highlight{background: #ffe58f;}       /* é«˜äº®å…­å€‹æœˆå…§ä¸”æœªè£œç™» */
  </style>
</head>
<body>
  <input id="uploader" type="file" accept=".xlsx,.xls,.csv" />
  <button id="toggle">æ¨™ç¤º/å–æ¶ˆæ¨™ç¤º</button>
  <button id="download">åŒ¯å‡º CSV</button>
  <div id="table"></div>

<script>
let originalData = [];   // ä¿ç•™åŸé †åº
let table = null;
let highlighted = false;

document.getElementById('uploader').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data, {type:'array'});
  const ws      = workbook.Sheets[workbook.SheetNames[0]];
  const json    = XLSX.utils.sheet_to_json(ws, {defval:''});
  // ğŸ‘‰ åœ¨é€™è£¡æŠŠä¸­æ–‡æ¬„ä½åè½‰æˆç¨‹å¼æ¬„ä½
  originalData = json.map(r=>({
     dept:          r['éƒ¨é–€'],
     sku:           r['è²¨è™Ÿ'],
     name:          r['å“å'],
     nearDate:      r['WK9â€¦æœ€è¿‘æ•ˆæœŸæ—¥'],
     farDate:       r['WK9â€¦æœ€é æ•ˆæœŸæ—¥'],
     stock:         +r['åº«å­˜é‡']||0,
     displayCode:   r['é™³åˆ—åœ–'],
     returnType:    r['é€€è²¨å‹æ…‹'],
     sixMonthYn:    r['å…­å€‹æœˆå…§æ•ˆæœŸå“ï¼Ÿ(Y/N)']==='Y',
     patchedYn:     r['å·²ç”¨ç›¤é»æ©Ÿè£œç™»è¨˜ï¼Ÿ(Y/N)']==='Y'
  }));

  renderTable(originalData);
});

function renderTable(data){
  if(table){table.destroy();}
  table = new Tabulator("#table", {
    data,
    layout:"fitColumns",
    height:"70vh",
    columns:[
      {title:"éƒ¨é–€", field:"dept", width:70},
      {title:"è²¨è™Ÿ", field:"sku", width:90},
      {title:"å“å", field:"name", minWidth:150},
      {title:"æœ€è¿‘æ•ˆæœŸ", field:"nearDate", sorter:"date", sorterParams:{format:"YYYYMMDD"}},
      {title:"åº«å­˜", field:"stock", hozAlign:"right"},
      {title:"6Må…§ï¼Ÿ", field:"sixMonthYn", width:70, formatter: yNFormatter},
      {title:"å·²è£œç™»ï¼Ÿ", field:"patchedYn", width:70, formatter: yNFormatter},
    ],
    rowFormatter: row=>{
        const d = row.getData();
        if(highlighted && d.sixMonthYn && !d.patchedYn){
          row.getElement().classList.add('highlight');
        }else{
          row.getElement().classList.remove('highlight');
        }
    }
  });
}

function yNFormatter(cell){ return cell.getValue() ? 'Y' : 'N'; }

document.getElementById('toggle').onclick=()=>{
  highlighted = !highlighted;
  if(table) table.redraw(true);
};

document.getElementById('download').onclick=()=>{
  if(!table) return;
  const rows = table.getData();               // ç›®å‰é¡¯ç¤ºé †åº
  const ws   = XLSX.utils.json_to_sheet(rows);
  const wb   = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "export");
  XLSX.writeFile(wb, "export.csv", {bookType:'csv'});
};
</script>
</body>
</html>
