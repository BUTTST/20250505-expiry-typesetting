<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>效期檢查表處理工具 V5.3 (庫存修正、介面微調)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overscroll-behavior-y: none; margin: 0; padding: 0; background-color: #f3f4f6;
        }
        /* Basic Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            /* table-layout: fixed; */ /* Let browser auto-adjust based on content */
        }
        .data-table th, .data-table td {
            border: 1px solid #e5e7eb; padding: 0.5rem 0.4rem; text-align: left;
            font-size: 0.75rem; vertical-align: middle;
            word-wrap: break-word;
        }
        .data-table th {
            background-color: #f9fafb; font-weight: 600; text-align: center;
            position: sticky; top: 0; z-index: 5;
            white-space: nowrap; /* Prevent header text wrapping */
        }
        .data-table tbody tr:hover { background-color: rgba(209, 213, 219, 0.6); }
        .data-table td.col-dept, .data-table td.col-stock, .data-table td.col-mark { text-align: center; }
        .data-table td.col-name { white-space: normal; }
        .data-table td.col-display-code { white-space: normal; word-break: break-all; line-height: 1.3; }
        .row-hidden { display: none; }

        /* Mark button styles */
        .mark-toggle {
            display: inline-block; padding: 0.1rem 0.5rem; border-radius: 9999px;
            font-size: 0.7rem; font-weight: 600; cursor: pointer; color: white;
            transition: background-color 0.2s ease, transform 0.1s ease; /* Added transform transition */
            vertical-align: middle;
        }
        .mark-toggle:active {
             transform: scale(0.95); /* Add click feedback */
        }
        .mark-toggle.yes { background-color: #10b981; }
        .mark-toggle.no { background-color: #ef4444; }
        .mark-toggle.yes:hover { background-color: #059669; }
        .mark-toggle.no:hover { background-color: #dc2626; }

        /* Expiry status colors */
        .expiry-danger { color: #dc2626; font-weight: 700; }
        .expiry-warning { color: #f59e0b; font-weight: 600; }

        .uploader-area.highlight { border-color: #3b82f6; background-color: #eff6ff; }
        .debug-info { font-family: monospace; white-space: pre-wrap; word-wrap: break-word; max-height: 100px; overflow-y: auto; }
        .hidden { display: none; }

        /* Button Styles */
        .filter-btn, .action-btn {
            font-weight: 600; padding: 0.25rem 0.75rem; border-radius: 0.375rem;
            font-size: 0.8rem; transition: background-color 0.15s ease-in-out, color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out, transform 0.1s ease; /* Added transform */
            border: 1px solid transparent; white-space: nowrap; line-height: 1.5;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .filter-btn:hover, .action-btn:hover {
             box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
             transform: translateY(-1px); /* Slight lift on hover */
        }
        .filter-btn:active, .action-btn:active {
            transform: scale(0.98); /* Click feedback */
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .filter-btn { background-color: #e5e7eb; color: #374151; }
        .filter-btn.active { background-color: #3b82f6; color: white; border-color: #2563eb; }
        .filter-btn.active:hover { background-color: #2563eb; transform: none; } /* Disable lift on active hover */

        .dept-btn-colored { color: white !important; border-color: rgba(0,0,0,0.1) !important; }
        .dept-btn-colored:hover { filter: brightness(90%); transform: translateY(-1px); }
        .dept-btn-colored.active { border-color: rgba(0,0,0,0.3) !important; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); transform: scale(0.98); }
        .dept-btn-colored.active:hover { filter: brightness(100%); transform: scale(0.98);} /* Keep active style on hover */

        /* No Data Message Style */
        #no-data-message {
            font-style: italic;
            color: #6b7280; /* gray-500 */
        }
    </style>
    <script>
      tailwind.config = {}
    </script>
</head>
<body class="bg-gray-100 text-gray-800 p-2 md:p-4">
    <div class="container mx-auto max-w-7xl space-y-3">
        <header class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-3 rounded-lg shadow-md text-center">
            <h1 class="text-lg md:text-xl font-bold">效期檢查表處理工具 V5.3 (庫存修正、介面微調)</h1>
        </header>

        <div id="error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-3 rounded-md shadow" role="alert">
            <p class="font-bold">發生錯誤</p>
            <p id="error-text" class="text-sm">錯誤詳情將顯示在這裡</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
             <div class="card bg-white p-3 rounded-lg shadow-md">
                <div class="uploader-area border-2 border-dashed border-gray-300 rounded-lg p-3 text-center transition-colors duration-200 h-full flex flex-col justify-center" id="uploader-area">
                    <input type="file" id="uploader" accept=".xls,.xlsx,.csv" class="hidden">
                    <button onclick="document.getElementById('uploader').click()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1.5 px-3 rounded-md transition duration-150 ease-in-out mb-1.5 text-sm shadow-sm hover:shadow">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 align-[-2px]" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /> </svg>
                        選擇檔案
                    </button>
                    <p class="text-gray-500 text-xs mb-1.5">或將檔案拖放至此處</p>
                    <button id="load-sample" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2.5 rounded-md transition duration-150 ease-in-out text-sm shadow-sm hover:shadow">
                        載入範例
                    </button>
                    <div class="file-info mt-2 text-xs text-gray-600" id="file-info"></div>
                </div>
            </div>

            <div id="file-info-display" class="card bg-blue-50 border-l-4 border-blue-400 p-3 rounded-md shadow hidden">
                <h3 class="text-base font-semibold text-blue-800 mb-1">文件資訊</h3>
                <div id="file-details" class="text-xs text-blue-700 space-y-0.5"></div>
                 <details class="mt-1.5">
                    <summary class="cursor-pointer text-xs font-semibold text-gray-600 hover:text-gray-800">顯示/隱藏處理日誌</summary>
                    <div id="debug-panel" class="debug-info mt-1 text-xs bg-white p-2 border border-gray-200 rounded"></div>
                 </details>
            </div>
        </div>

        <div id="content-area" class="hidden space-y-3">
            <div class="card bg-white p-3 rounded-lg shadow-md">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
                    <div class="mb-2 sm:mb-0">
                        <strong class="font-semibold mr-2 text-gray-700 text-sm align-middle">篩選:</strong>
                        <div id="filter-buttons-container" class="inline-block align-middle"></div>
                    </div>
                    <div id="action-buttons-group" class="flex flex-wrap gap-2 sm:ml-auto">
                         <button id="btn-show-marked" class="action-btn bg-emerald-100 hover:bg-emerald-200 text-emerald-700">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 align-[-2px]" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /> </svg>
                             <span id="marked-btn-text">僅顯示標記</span>
                         </button>
                         <button id="btn-reset-mark" class="action-btn bg-red-100 hover:bg-red-200 text-red-700">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 align-[-2px]" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /> </svg>
                             重置標記
                         </button>
                     </div>
                 </div>
            </div>

            <div id="table-container" class="bg-white rounded-lg shadow-md overflow-x-auto">
                 <table class="data-table">
                     <thead>
                         <tr>
                             <th style="width: 7%;">部</th>
                             <th style="width: 11%;">貨號</th>
                             <th style="width: 35%;">品名</th>
                             <th style="width: 13%;">近效期</th>
                             <th style="width: 17%;">陳列圖</th>
                             <th style="width: 10%;">庫存</th>
                             <th style="width: 7%;">標記</th>
                         </tr>
                     </thead>
                     <tbody id="data-tbody"></tbody>
                 </table>
                 <div id="no-data-message" class="p-4 text-center hidden">沒有數據可顯示</div>
            </div>
        </div>

        <div id="loading" class="hidden text-center py-10">
            <svg class="animate-spin h-6 w-6 text-blue-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"> <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path> </svg>
            <p class="text-gray-600 font-semibold text-sm">處理中...</p>
        </div>
    </div>

    <script>
        // --- 全域變數與常數 ---
        let rawData = [], processedData = [], fileMetadata = {};
        let currentFilter = { type: 'all', value: 'all' };
        let filterBeforeMarked = { type: 'all', value: 'all' };

        const HEADER_SCAN_ROWS = 20;
        const HEADER_KEYWORDS = ['部門', '貨號', '品名', '效期', '庫存', '陳列圖'];
        const MIN_KEYWORD_MATCH = 2;
        const CATEGORIES = { "零食區": ["28", "29"], "藥師區": ["02", "03", "04", "05", "07"] };

        const deptColorPalette = [ { light: 'bg-blue-50', dark: 'bg-blue-100', btn: 'bg-blue-500' }, { light: 'bg-green-50', dark: 'bg-green-100', btn: 'bg-green-500' }, { light: 'bg-purple-50', dark: 'bg-purple-100', btn: 'bg-purple-500' }, { light: 'bg-yellow-50', dark: 'bg-yellow-100', btn: 'bg-yellow-500' }, { light: 'bg-pink-50', dark: 'bg-pink-100', btn: 'bg-pink-500' }, { light: 'bg-indigo-50', dark: 'bg-indigo-100', btn: 'bg-indigo-500' }, { light: 'bg-teal-50', dark: 'bg-teal-100', btn: 'bg-teal-500' }, { light: 'bg-red-50', dark: 'bg-red-100', btn: 'bg-red-500' }, { light: 'bg-gray-50', dark: 'bg-gray-200', btn: 'bg-gray-500' }, { light: 'bg-orange-50', dark: 'bg-orange-100', btn: 'bg-orange-500' }, { light: 'bg-lime-50', dark: 'bg-lime-100', btn: 'bg-lime-500' }, { light: 'bg-cyan-50', dark: 'bg-cyan-100', btn: 'bg-cyan-500' }, ];
        const deptColorMap = {};

        function getDeptColorClasses(dept) {
            if (!deptColorMap[dept]) {
                const colorIndex = Object.keys(deptColorMap).length % deptColorPalette.length;
                deptColorMap[dept] = deptColorPalette[colorIndex];
            }
            return deptColorMap[dept];
        }

        const uploaderArea = document.getElementById('uploader-area');
        const uploader = document.getElementById('uploader');
        const fileInfo = document.getElementById('file-info');
        const fileInfoDisplay = document.getElementById('file-info-display');
        const fileDetails = document.getElementById('file-details');
        const contentArea = document.getElementById('content-area');
        const loading = document.getElementById('loading');
        const btnShowMarked = document.getElementById('btn-show-marked');
        const markedBtnText = document.getElementById('marked-btn-text');
        const btnResetMark = document.getElementById('btn-reset-mark');
        const filterButtonsParentContainer = document.getElementById('filter-buttons-container');
        const loadSample = document.getElementById('load-sample');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const debugPanel = document.getElementById('debug-panel');
        const tableBody = document.getElementById('data-tbody');
        const noDataMessage = document.getElementById('no-data-message');

        function debug(message) { console.log(`[DEBUG] ${message}`); if (debugPanel) { const ts = new Date().toLocaleTimeString(); debugPanel.innerHTML += `[${ts}] ${message}\n`; debugPanel.scrollTop = debugPanel.scrollHeight; } }
        function showError(message, error) { console.error(`[ERROR] ${message}`, error); errorText.textContent = message + (error ? ` (${error.name}: ${error.message})` : ''); errorMessage.classList.remove('hidden'); loading.classList.add('hidden'); contentArea.classList.add('hidden'); }
        function hideError() { errorMessage.classList.add('hidden'); }
        function parseDate(dateInput) {
            if (!dateInput) return null; let date;
            if (dateInput instanceof Date) { date = dateInput; }
            else if (typeof dateInput === 'number') { if (dateInput > 0 && dateInput < 60) { dateInput++; } date = new Date(Math.round((dateInput - 25569) * 86400 * 1000)); }
            else if (typeof dateInput === 'string') {
                const str = dateInput.trim().replace(/\./g, '/');
                if (/^\d{4}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(str)) { date = new Date(str.replace(/-/g, '/')); }
                else if (/^\d{1,2}[\/-]\d{1,2}[\/-]\d{4}$/.test(str)) { const p = str.split(/[/-]/); date = new Date(p[2], p[0] - 1, p[1]); }
                else if (/^\d{2,3}[\/-]\d{1,2}[\/-]\d{1,2}$/.test(str)) { const p = str.split(/[/-]/).map(Number); if (p[0] < 200) date = new Date(p[0] + 1911, p[1] - 1, p[2]); }
            }
            if (date && !isNaN(date.getTime())) { return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`; }
            return null;
        }
        function handleFile(file) {
            hideError(); debugPanel.textContent = ''; debug(`開始處理檔案: ${file.name}`);
            loading.classList.remove('hidden'); contentArea.classList.add('hidden'); tableBody.innerHTML = ''; noDataMessage.classList.add('hidden');
            fileInfo.textContent = `檔案：${file.name}`;
            const reader = new FileReader();
            reader.onload = e => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array', cellDates: true}); processExcelData(workbook); } catch (err) { showError(`讀取或解析 Excel 檔案 '${file.name}' 失敗`, err); }};
            reader.onerror = err => showError(`檔案 '${file.name}' 讀取錯誤`, err);
            reader.readAsArrayBuffer(file);
        }
        function processExcelData(workbook) {
            const firstSheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[firstSheetName];
            if (!worksheet) { showError("工作表未找到。"); return; }
            debug(`成功讀取工作表: ${firstSheetName}`); let jsonData = []; let headerRowIndex = 0; let maxMatches = 0;
            const allRowsAsArrays = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", rawNumbers: false });
            for (let i = 0; i < Math.min(HEADER_SCAN_ROWS, allRowsAsArrays.length); i++) {
                const currentRow = allRowsAsArrays[i]; if (!Array.isArray(currentRow)) continue; let currentMatches = 0;
                HEADER_KEYWORDS.forEach(kw => { if (currentRow.some(cell => cell && String(cell).trim().includes(kw))) currentMatches++; });
                if (currentMatches > maxMatches) { maxMatches = currentMatches; headerRowIndex = i; }
            }
            if (maxMatches >= MIN_KEYWORD_MATCH) {
                debug(`自動偵測到表頭在第 ${headerRowIndex + 1} 行`); const headerNames = allRowsAsArrays[headerRowIndex].map((h, idx) => h ? String(h).trim() : `UNKNOWN_${idx}`);
                jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "", header: headerNames, range: headerRowIndex + 1 }); debug(`使用偵測到的表頭轉換了 ${jsonData.length} 行。`);
            } else {
                debug("未偵測到明確表頭，用第一行。"); jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "", rawNumbers: false }); if (jsonData.length > 0) debug(`使用預設表頭轉換了 ${jsonData.length} 行。`);
            }
            rawData = jsonData; debug(`原始數據行數: ${rawData.length}`);
            fileMetadata = { title: firstSheetName, week: "未知", time: `處理時間：${new Date().toLocaleTimeString('zh-TW')}` };
            if (headerRowIndex > 0) { for (let i = 0; i < headerRowIndex; i++) { const rs = allRowsAsArrays[i].join(" "); if (rs.includes("週別")) { fileMetadata.week = rs; break; } } }
            fileDetails.innerHTML = `<p><strong>標題：</strong>${fileMetadata.title}</p><p><strong>${fileMetadata.week}</strong></p><p><strong>${fileMetadata.time}</strong></p>`;
            fileInfoDisplay.classList.remove('hidden');
            if (rawData.length > 0) { processAndNormalizeData(); } else { showError("檔案中無數據。"); }
        }
        function parseDisplayCodeForSort(code) {
            if (!code || typeof code !== 'string' || code.length < 13) { return { prefix: code || '', letter: '', layer: Infinity, position: Infinity }; }
            try {
                const prefix = code.substring(0, 7); const letter = code.substring(7, 8).toUpperCase();
                const layer = parseInt(code.substring(8, 10), 10); const position = parseInt(code.substring(10, 13), 10);
                if (isNaN(layer) || isNaN(position)) { return { prefix: prefix, letter: letter, layer: Infinity, position: Infinity }; }
                return { prefix, letter, layer, position };
            } catch (e) { return { prefix: code, letter: '', layer: Infinity, position: Infinity }; }
        }
        function processAndNormalizeData() {
            try {
                if (!rawData || rawData.length === 0) throw new Error("沒有可供處理的原始數據");
                debug(`開始標準化 ${rawData.length} 行...`); let processedCount = 0;
                processedData = rawData.map((row, index) => {
                    const normalized = normalizeRow(row, index);
                    if (normalized?.dept && normalized?.name) { processedCount++; return normalized; } return null;
                }).filter(row => row !== null);
                debug(`標準化完成。有效: ${processedCount}, 過濾: ${rawData.length - processedCount}`);
                if (processedCount === 0) throw new Error("數據標準化後無有效行。");
                debug("開始自動排序...");
                processedData.sort((a, b) => {
                